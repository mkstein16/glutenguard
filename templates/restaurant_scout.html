<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Celia - Restaurant Scout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/restaurant_scout.css') }}">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header>
            <a href="/" class="icon-btn" aria-label="Back to home">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
            </a>
            <div class="header-content">
                <h1>Restaurant Scout</h1>
                <p class="tagline">Research before you dine</p>
            </div>
        </header>

        <main>
            <!-- Section 1: Search -->
            <div id="search-view">
                <script>
                    // Hide search form immediately if URL has name param (prevents flash)
                    if (new URLSearchParams(window.location.search).get("name")) {
                        document.getElementById("search-view").style.display = "none";
                    }
                </script>
                <div class="search-form">
                    <label for="restaurant-name">Restaurant Name</label>
                    <input type="text" id="restaurant-name" placeholder="e.g. Olive Garden, Chipotle..." autocomplete="off">

                    <label for="scout-location">Location</label>
                    <input type="text" id="scout-location" placeholder="City or neighborhood" autocomplete="off">
                    <p class="input-helper">Helps find the right location — especially for common restaurant names</p>

                    <button id="scout-btn" class="btn btn-primary btn-full">Scout This Restaurant</button>
                    {% if searches_remaining > 0 %}
                    <p class="search-counter">{{ searches_remaining }} of 5 free searches remaining</p>
                    {% else %}
                    <p class="search-counter">No free searches remaining · <a href="#waitlist">Join the waitlist</a></p>
                    {% endif %}
                </div>
            </div>

            <!-- Section: Search Limit Reached -->
            <div id="limit-reached-view" class="hidden">
                <div class="limit-card">
                    <div class="limit-icon">5</div>
                    <h2>You've used all 5 free restaurant searches!</h2>
                    <p class="limit-subtitle">Want more? Join our Pro waitlist.</p>

                    <form id="waitlist-form" class="waitlist-form">
                        <input type="email" id="waitlist-email" placeholder="you@email.com" required>
                        <button type="submit" class="btn btn-primary btn-full">Join the Waitlist</button>
                    </form>

                    <div id="waitlist-success" class="waitlist-success hidden">
                        <p>You're on the list! We'll let you know when Pro launches.</p>
                    </div>

                    <hr class="limit-divider">

                    <p class="request-heading">Want a specific restaurant analyzed?</p>
                    <p class="request-subtitle">Request it and we'll have your report ready within 24 hours.</p>

                    <form id="request-restaurant-form" class="waitlist-form">
                        <input type="text" id="request-restaurant-name" placeholder="Restaurant name" required>
                        <input type="text" id="request-restaurant-location" placeholder="Location (optional)">
                        <button type="submit" class="btn btn-primary btn-full">Request This Restaurant</button>
                    </form>

                    <div id="request-success" class="waitlist-success hidden">
                        <p>Request received! We'll have your report ready within 24 hours.</p>
                    </div>

                    <button id="limit-back-btn" class="btn btn-secondary btn-full" disabled>Search Another Restaurant</button>
                </div>
            </div>

            <!-- Section 2: Loading -->
            <div id="scout-loading" class="hidden">
                <div class="loading-header">
                    <p class="loading-header-text">This restaurant hasn't been searched yet — researching it now. Next time it'll be instant.</p>
                </div>
                <div class="loading-steps">
                    <div class="loading-step" data-step="0">
                        <span class="step-indicator"></span>
                        <span class="step-text">Searching for restaurant website...</span>
                    </div>
                    <div class="loading-step" data-step="1">
                        <span class="step-indicator"></span>
                        <span class="step-text">Checking gluten-free reviews...</span>
                    </div>
                    <div class="loading-step" data-step="2">
                        <span class="step-indicator"></span>
                        <span class="step-text">Searching celiac community reviews...</span>
                    </div>
                    <div class="loading-step" data-step="3">
                        <span class="step-indicator"></span>
                        <span class="step-text">Analyzing menu and safety...</span>
                    </div>
                    <div class="loading-step" data-step="4">
                        <span class="step-indicator"></span>
                        <span class="step-text">Building your safety report...</span>
                    </div>
                </div>
            </div>

            <!-- Section 3: Results -->
            <div id="scout-results" class="hidden">
                <!-- 1. HERO CARD -->
                <div id="score-card" class="hero-card">
                    <div class="hero-top">
                        <div class="score-column">
                            <div id="safety-score-ring" class="score-ring"></div>
                            <div id="score-label" class="score-label"></div>
                            <div id="score-context" class="score-context"></div>
                        </div>
                        <div class="hero-info">
                            <h2 id="scout-restaurant-name"></h2>
                            <p id="scout-cuisine" class="cuisine-type"></p>
                            <div id="safety-label" class="safety-label-badge"></div>
                        </div>
                    </div>
                    <p id="scout-summary" class="hero-summary"></p>

                    <!-- Action Buttons: Save & Share -->
                    <div id="score-card-actions" class="score-card-actions">
                        {% if user %}
                        <button id="save-restaurant-btn" class="btn btn-save">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span>Save</span>
                        </button>
                        {% else %}
                        <a href="/signin" class="btn btn-save-signin">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span>Sign In</span>
                        </a>
                        {% endif %}
                        <button id="share-report-btn" class="btn btn-share">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                            <span>Share</span>
                        </button>
                    </div>
                    <div id="action-feedback-container" class="action-feedback-container">
                        <span id="save-feedback" class="action-feedback hidden"></span>
                        <span id="share-feedback" class="action-feedback hidden"></span>
                    </div>
                </div>

                <!-- SCORE EXPLAINER -->
                <details class="score-explainer">
                    <summary>What does this score mean?</summary>
                    <div class="score-explainer-content">
                        <div class="score-tier"><span class="tier-range tier-green">9-10</span><span class="tier-text"><strong>Go with confidence</strong> — Dedicated GF kitchen or certified. Very low risk.</span></div>
                        <div class="score-tier"><span class="tier-range tier-amber">7-8</span><span class="tier-text"><strong>Safe with communication</strong> — Good GF options and protocols. Tell your server about celiac.</span></div>
                        <div class="score-tier"><span class="tier-range tier-orange">5-6</span><span class="tier-text"><strong>Proceed with caution</strong> — GF options exist but cross-contamination risk is real. Ask questions.</span></div>
                        <div class="score-tier"><span class="tier-range tier-red">3-4</span><span class="tier-text"><strong>High risk</strong> — Limited options, limited awareness. Eat here only as a last resort.</span></div>
                        <div class="score-tier"><span class="tier-range tier-red">1-2</span><span class="tier-text"><strong>Avoid</strong> — Gluten is everywhere. Not worth the risk.</span></div>
                    </div>
                </details>

                <!-- 2. WHY IT'S SAFE Section -->
                <div id="safety-indicators" class="result-section safety-section hidden">
                    <h3 id="safety-indicators-title" class="section-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        <span id="safety-indicators-heading">Why It's Safe</span>
                    </h3>
                    <ul id="safety-indicators-list" class="indicator-list"></ul>
                </div>

                <!-- 3. THINGS TO KNOW Section (conditional) -->
                <div id="things-to-know" class="result-section warning-section hidden">
                    <h3 class="section-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        Things to Know
                    </h3>
                    <ul id="things-to-know-list" class="warning-list"></ul>
                </div>

                <!-- 4. EXPANDABLE SECTIONS -->
                <div class="expandable-sections">
                    <!-- Menu Highlights -->
                    <details class="expand-section hidden" id="menu-highlights">
                        <summary class="expand-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
                            Menu Highlights
                            <span class="expand-chevron">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </span>
                        </summary>
                        <div class="expand-content">
                            <div id="menu-pills" class="menu-pills"></div>
                            <button id="see-all-menu-btn" class="btn-link hidden">See all safe items</button>
                        </div>
                    </details>

                    <!-- Staff Knowledge -->
                    <details class="expand-section hidden" id="staff-knowledge-card">
                        <summary class="expand-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            Staff Knowledge: <span id="staff-knowledge-badge" class="staff-badge"></span>
                            <span class="expand-chevron">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </span>
                        </summary>
                        <div class="expand-content">
                            <p id="staff-knowledge-detail" class="staff-detail"></p>
                        </div>
                    </details>

                    <!-- Call Script -->
                    <details class="expand-section" id="call-script-section" open>
                        <summary class="expand-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                            <span id="call-script-heading">What to Ask</span>
                            <span class="expand-chevron">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </span>
                        </summary>
                        <p class="expand-subtitle">When calling ahead or talking to your server</p>
                        <div class="expand-content">
                            <p id="call-script-context" class="script-context"></p>
                            <div id="script-presets" class="script-presets">
                                <button class="preset-btn active" data-preset="quick">Quick</button>
                                <button class="preset-btn" data-preset="thorough">Thorough</button>
                            </div>
                            <ol id="call-script-list"></ol>
                            <button id="show-additional-toggle" class="btn-link hidden">Show All Questions</button>
                        </div>
                    </details>

                    <!-- Full Menu Analysis -->
                    <details class="expand-section" id="full-menu-section">
                        <summary class="expand-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                            Full Menu Analysis
                            <span class="expand-chevron">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </span>
                        </summary>
                        <div class="expand-content">
                            <div class="menu-category safe-category">
                                <h4><span class="cat-icon">✓</span> Likely Safe <span class="cat-count" id="safe-count"></span></h4>
                                <ul id="likely-safe-list" class="menu-list"></ul>
                            </div>
                            <div class="menu-category ask-category">
                                <h4><span class="cat-icon">?</span> Ask First <span class="cat-count" id="ask-count"></span></h4>
                                <ul id="ask-first-list" class="menu-list"></ul>
                            </div>
                            <div class="menu-category avoid-category">
                                <h4><span class="cat-icon">!</span> Red Flags <span class="cat-count" id="flags-count"></span></h4>
                                <ul id="red-flags-list" class="menu-list"></ul>
                            </div>
                        </div>
                    </details>

                    <!-- Full Analysis -->
                    <details class="expand-section" id="full-analysis-section">
                        <summary class="expand-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            Full Analysis
                            <span class="expand-chevron">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </span>
                        </summary>
                        <div class="expand-content">
                            <div class="analysis-block">
                                <h4>Research Summary</h4>
                                <p id="research-summary"></p>
                            </div>
                            <div class="analysis-block" id="cuisine-context-block">
                                <h4>Cuisine Context</h4>
                                <div id="cuisine-context-content">
                                    <p class="context-label">Common Risks:</p>
                                    <ul id="cuisine-general-risks"></ul>
                                    <p class="context-label">Common Positives:</p>
                                    <ul id="cuisine-general-positives"></ul>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Community Reviews -->
                    <details class="expand-section" id="community-section">
                        <summary class="expand-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Community Reviews
                            <span class="expand-chevron">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </span>
                        </summary>
                        <div class="expand-content">
                            <p id="community-sentiment"></p>
                        </div>
                    </details>
                </div>

                <!-- Action Buttons -->
                <div class="results-actions">
                    <button id="find-alternatives-btn" class="btn btn-alt btn-full hidden">Find Better Options Nearby</button>

                    <!-- Alternatives -->
                    <div id="alternatives-section" class="hidden">
                        <div id="alternatives-loading" class="hidden">
                            <div class="small-spinner"></div>
                            <p class="loading-hint">Finding safer alternatives nearby...</p>
                        </div>
                        <div id="alternatives-results" class="hidden">
                            <h3>Better Options Nearby</h3>
                            <div id="alternatives-list"></div>
                        </div>
                    </div>

                    <button id="new-scout-btn" class="btn btn-secondary btn-full">Search Another Restaurant</button>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="/" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>Home</span>
            </a>
            <a href="/my-safe-spots" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                </svg>
                <span>Saved</span>
            </a>
            <button class="nav-item" id="account-nav-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Account</span>
            </button>
        </nav>

        <!-- Account Modal -->
        <div class="account-modal-overlay" id="account-modal">
            <div class="account-modal">
                <div class="account-modal-header">
                    <h3>Account</h3>
                    <button class="account-modal-close" id="account-modal-close">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                {% if user %}
                <div class="account-email">
                    <div class="account-email-label">Signed in as</div>
                    <div class="account-email-value">{{ user.email }}</div>
                </div>
                <a href="/signout" class="account-signout">Sign Out</a>
                {% else %}
                <a href="/signin" class="account-signin">Sign In</a>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/restaurant_scout.js') }}"></script>
    <script>
        // Account modal toggle
        const accountBtn = document.getElementById('account-nav-btn');
        const accountModal = document.getElementById('account-modal');
        const accountClose = document.getElementById('account-modal-close');

        accountBtn.addEventListener('click', () => {
            accountModal.classList.add('visible');
        });

        accountClose.addEventListener('click', () => {
            accountModal.classList.remove('visible');
        });

        accountModal.addEventListener('click', (e) => {
            if (e.target === accountModal) {
                accountModal.classList.remove('visible');
            }
        });
    </script>
</body>
</html>
